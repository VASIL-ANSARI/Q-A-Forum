<p>I dived into shoulda code and found that it uses predefined set of values for <code>validate_uniqueness_of</code> and there is no way to change it (except of hacking <code>Shoulda::Matchers::Util</code> class).</p>

<pre><code>def self.dummy_value_for(column_type, array: false)
  if array
    [dummy_value_for(column_type, array: false)]
  else
    case column_type
    when :integer
      0
    when :date
      Date.new(2100, 1, 1)
    when :datetime, :timestamp
      DateTime.new(2100, 1, 1)
    when :time
      Time.new(2100, 1, 1)
    when :uuid
      SecureRandom.uuid
    when :boolean
      true
    else
      'dummy value'
    end
  end
end
</code></pre>

<p>So I built following workaround:</p>

<pre><code>context 'coupon code should be unique for the same currency' do
  before { create(:coupon_amount, currency: 'USD', code: 'aaa') }
  it 'allows to create a coupon with the same code and another currency' do
    create(:coupon_amount, currency: 'EUR', code: 'aaa')
  end
  it 'does not allow to create a coupon with the same code and currency' do
    expect { create(:coupon_amount, currency: 'USD', code: 'aaa') }.to(
      raise_error(ActiveRecord::RecordInvalid, 'Validation failed: Code has already been taken')
    )
  end
end
</code></pre>

<p>It validates uniqueness with right values and works like charm. </p>

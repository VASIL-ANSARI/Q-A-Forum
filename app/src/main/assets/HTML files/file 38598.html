<p>Its quite hard to help you on such a problem without setting up a big base of code to test, so I'm giving you a strong and commented base  to start with.</p>

<pre><code>function my_recc_func ($parent, $before, $after, $array, $my_data) {

  // Lets search the name in the keys of my current node (root or children)
  foreach ($array as $key =&gt; $value) {
    if ($key == $parent) {
      // Found it, so I'll do something here, and return true anyway
      $pos = 0;
      // Now looking for after or before names, and finding the correct pos at which I want to add my_data
      foreach ($value[$data][$children] as $name =&gt; $arr) {
        ++$pos;
        if ($name == $after) {
          break;
        }
        if ($name == $before) {
          --$pos;
          break;
        }
      }
      // Using the array_slice trick to insert my_data where I want inside of the array
      // It is now my new children with data inserted
      $new_children = array_slice ($value[$data][$children], 0, $pos, true) + $my_data + array_slice, $pos, count($value[$data][$children]), true);
      // $value[$data][$children] becomes $new_children
      // Code it as you want, if you need references or not or with a temporary array
      return true;
    } else {
      // That name isn't the correct one, so I'll see in the children of that node
      if (my_recc_func($parent, $before, $after, $value[$data][$children])) {
        return true;
      }
      // If I didn't find it in the children nodes, I'll keep going with the following nodes of the current parent
    }
  }
  // Didn't find anything in the children or in the current node, bye
  return false;

}
</code></pre>

<p>You might need to apply some changes to get it to work (as you said using references, or checking for incoherence between before and after) but the main logic is here.</p>

<p>Hope it helps you to get something effective.</p>

<p><strong>Edit :</strong> Ok, gave a look at your last attempt, and it seems like you already had something very similar. If you tell me what you problem was with that code, I'll help you to make it work</p>

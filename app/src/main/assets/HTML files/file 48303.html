<p>Sorry, I just read your long comment.</p>

<p>Yes, <code>@user</code> is set outside the outer loop, and therefore <code>@user.contacts</code> will not be refreshed/reloaded from the database on iterations of this loop.</p>

<p>You can do two things to solve this, either reload your <code>@user</code> on each iteration of your loop: <code>@user.reload</code> to ensure that the <code>contacts</code> is reloaded from the DB, or change the way you build new <code>Contact</code>s to use the association, so your <code>elsif</code> becomes:</p>

<pre><code>elsif @contact_already_exists == 0
  @user.contacts.create(email: senderName, realName: senderActualName, importancePoints: 0)
  puts "new contact saved"
</code></pre>

<p>Although my original answer was off the mark, it <strong>is</strong> still important to check the return of that <code>create</code> (or <code>save</code>) or change it to the <code>!</code> alternative so an exception is raised.</p>

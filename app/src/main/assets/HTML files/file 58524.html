<p>I found. Need to use <code>SelectMany</code> with second parameter <code>resultSelector</code>:</p>

<pre><code>dbContext.Visits.Where(x =&gt; x.IsActive)
                .SelectMany(x =&gt; x.VisitLines, (v, vl) =&gt; new
                {
                  v.Id,
                  vl.ProcedureId
                })
                .GroupBy(x =&gt; x.ProcedureId)
                          .Select(x =&gt; new
                          {
                              Id = x.Key,
                              VisitCount = x.Count()
                          }).ToArray();
</code></pre>

<p>It generates the desired SQL, but with exception that I need distinct count by visit.</p>

<p>And if I change <code>VisitCount = x.Distinct().Count()</code> then EF generates a query with few subqueries again. But the main issue resolved</p>

<p>Here's where your downloadUrl is declared:</p>

<pre><code>function downloadUrl(url, callback) {
       var request = window.ActiveXObject ?
            new ActiveXObject('Microsoft.XMLHTTP') :
            new XMLHttpRequest;

       request.onreadystatechange = function () {
            if (request.readyState == 4) {
                request.onreadystatechange = doNothing;
                callback(request.responseText, request.status);
            }
       };

       request.open('GET', url, true);
       request.send(null);
}
//two other functions elided

})   // &lt;------ what's this?!
</code></pre>

<p>It looks like your declaring this function inside of another scope, which means it's not globally available, like your code assumes it is.  This is likely why you're getting the undeclared error</p>

<p><strong>EDIT</strong></p>

<p>I moved your downloadUrl function to the very <strong>top</strong> of the script, and you no longer get this error.  Unfortunately you now get an error about doNothing being undefined.  </p>

<p>You just need to load all this JavaScript into a JavaScript-friendly IDE (so not Visual Studio) and really untangle all these braces and parenthesis, so you can figure out where your unwanted scope is. </p>

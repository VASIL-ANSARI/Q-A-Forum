<p>Not sure how many bugs <code>parse_url()</code> has, but this might help:</p>

<blockquote>
  <p>As the "first-match-wins" algorithm is identical to the "greedy"
     disambiguation method used by POSIX regular expressions, it is
     natural and commonplace to use a regular expression for parsing the
     potential five components of a URI reference.</p>
  
  <p>The following line is the regular expression for breaking-down a
     well-formed URI reference into its components.</p>
</blockquote>

<pre><code>^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?
 12            3  4          5       6  7        8 9
</code></pre>

<p>Source: <a href="http://tools.ietf.org/html/rfc3986#page-51" rel="nofollow">http://tools.ietf.org/html/rfc3986#page-51</a></p>

<p>It breaks down the location as:</p>

<pre><code>$2 - scheme
$4 - host
$5 - path
$6 - query string
$8 - fragment
</code></pre>

<p>To rebuild, you could use:</p>

<pre><code>$1 . $3 . $5 . $6 . $8
</code></pre>

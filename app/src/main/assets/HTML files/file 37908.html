<p>According to the <a href="https://github.com/plataformatec/devise#test-helpers" rel="nofollow">Devise TestHelper documentation</a>, you should only be using</p>

<pre><code>@request.env["devise.mapping"] = Devise.mappings[:user]
</code></pre>

<p>when you are testing a controller that inherits a Devise controller. I guess the AlbumsController doesn't inherits from a Devise Controller. I don't think you need that line for these tests.</p>

<p>Try removing this line or creating another helper method that does only the sign_in and the switch:</p>

<pre><code>def simple_sign_in_and_switch(user)
  sign_in :user, user
  Apartment::Tenant.switch(user.username)
end
</code></pre>

<p>And then call that method instead in your test case:</p>

<pre><code>before(:each) do
  simple_sign_in_and_switch_schema @user
end
</code></pre>

<p>If this works try removing the faulty line completely and run your full test suite to see if it is needed somewhere else. If it is, extract that line in another method and use it only when you need.</p>

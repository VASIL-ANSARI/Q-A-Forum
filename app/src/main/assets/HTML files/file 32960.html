<ul>
<li>You could move some of the conditions at least to the outer loop, and maybe pre-compute some of the terms inside the conditions, though this may be optimized anyway.</li>
<li>Call update only for the rectangle(s) you modified</li>
<li>Where do you get the time stamp? Maybe you lose time somewhere else?</li>
</ul>

<p>You need to send a (non-websocket) response to alter the session.  Just popping the value does nothing, as the browser doesn't update it's side and just sends the data again next request.  Right now, the application:</p>

<ol>
<li>Logs in, sets value, returns response</li>
<li>Sends request (for websocket), sends value

<ol>
<li>Whatever response socket sends occurs before <code>test_connect</code> event handler, so doesn't pop value</li>
<li>Event handler runs, no way to tell browswer that session has changed</li>
</ol></li>
<li>Browser sends request for other page, sends value</li>
</ol>

<p>Probably the simplest solution is to store the session server side, where you can alter it even without sending a response.</p>

<p>since you pass <code>getLastImportTime</code> function to <code>when</code> helper method, it should explicitly return a <code>promise</code>, (but in <code>getLastImportTime()</code> you are returning nothing and <code>when()</code> is expecting you to pass a <em>promise</em>) otherwise the helper could evaluate it as an immediate resolved (or rejected) promise.</p>

<p>This could explain why it seems that function in <code>pipe</code> is executed before <code>getLastImportTime()</code></p>

<p>So try to change your function like so</p>

<pre><code>var getLastImportTime = function () {
   ...
   database.open();
   database.query("SELECT  ...");

   return buildPromise.promise();
};
</code></pre>

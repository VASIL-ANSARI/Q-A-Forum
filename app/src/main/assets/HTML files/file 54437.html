<p>The most problematic part of your task is the calculation of aggregate Product in pure SQL (as FYI: there are many standard aggregate functions, like Sum(), Min(), Max(), etc. but no Product P()). One possible solution described in: Aggregate Product function extends SQL (<a href="http://www.codeproject.com/Tips/137564/Aggregate-Product-function-extends-SQL" rel="nofollow">http://www.codeproject.com/Tips/137564/Aggregate-Product-function-extends-SQL</a>)
is based on math equation:</p>

<pre><code>N           N
P(Xi)= Exp(SUM(Log(Xi)))
i=1         i=1
</code></pre>

<p>which translated into following SQL statement:</p>

<pre><code>SELECT Exp(Sum(IIf([Num]=0,0,Log([Num]))))*IIf(Min([Num])=0,0,1) AS P
FROM Table1
</code></pre>

<p>You can apply this solution to your problem. In order to calculate the running (moving) <code>avg</code> you may build the self-join of the data Table and apply the computation for all rows previous to the current. The actual implementation will depend on the particular Database you are using.</p>

<p>Hope this may help.</p>

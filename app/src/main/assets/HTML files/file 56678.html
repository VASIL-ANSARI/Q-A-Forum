<pre><code>SELECT * 
FROM
    (SELECT TOP (@NumOfRecords) 
         i.Number as Number,
         i.Description as Description,
         SUM(d.OrderQty) as TotalCount,
         SUM(CASE 
            WHEN h.OrderSourceID = 1 THEN d.OrderQty 
            ELSE 0 
         END) as TotalSource_1,
         SUM(CASE 
            WHEN h.OrderSourceID = 2 THEN d.OrderQty
            ELSE 0 
         END) as TotalSource_2,
         SUM(CASE 
            WHEN h.OrderSourceID = 3 THEN d.OrderQty
            ELSE 0 
         END) as TotalSource_3 
     FROM 
         tblHeader h
     INNER JOIN 
         tblDetail d on h.SalesOrderID = d.SalesOrderID
     INNER JOIN 
         tblItemDetail id on id.ItemID = d.ItemID
     INNER JOIN 
         tblItem i on d.ItemID = i.ItemID
     WHERE
         CONVERT(DATE, h.OrderDate) BETWEEN @StartDate AND @EndDate
     GROUP BY
         id.ItemID, i.Number, i.Description, h.OrderSourceID
     ORDER BY
         SUM(d.OrderQty) DESC) x
ORDER BY
    x.Number
</code></pre>

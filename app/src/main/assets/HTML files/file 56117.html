<p>I don't have your data to test with, but I would avoid these constructs:</p>

<pre><code>[x for x in range(5000) if t_f_ext[0,x]!=0]
</code></pre>

<p>That list comprehension could possibly generate a large list.</p>

<p>If you use generators instead, you can avoid the construction of the lists:</p>

<pre><code>(x for x in xrange(5000) if t_f_ext[0,x] != 0)
</code></pre>

<p>(Note the change to <code>xrange</code> as well.)</p>

<p>Since you're essentially filtering, you could also use <code>ifilter</code> from <code>itertools</code>. For example, this filters the even numbers from 0 to 100:</p>

<pre><code>ifilter(lambda x: x % 2 == 0, xrange(101))
</code></pre>

<p>Another option is to use this alternate construct:</p>

<pre><code>for s in xrange(5000)
    if t_f_ext[0,x] == 0:
        continue
    for r in xrange(400):
        if t_f_ext[x,s] == 0:
            continue
        [...]
</code></pre>

<p>Once you make those changes, run it with <code>cProfile</code> to see where your hot spots are.</p>

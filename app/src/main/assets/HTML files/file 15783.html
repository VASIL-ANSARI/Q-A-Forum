<pre><code>$file = fopen($datafile, 'r'); 

$Out = '';
$LastStore = '';
while (($result = fgetcsv($file)) !== false) 
{ 
    if (preg_match('/\d{10}$/', $result[0],$store)) { 
        $LastStore = $store;
    } elseif (preg_match('/^\d{7}/', $result[0],$transaction)) { {
        $aT = array("Store"=&gt;$LastStore, "Item"=&gt;$transaction[0],"Desc"=&gt;$transaction[1],"Qty"=&gt;$transaction[2],"Price"=&gt;$transaction[3])
        $Out .= implode(',', $aT) . "\n";

    }
} 
fclose($file); 

// Output as file (if this is as intended). Otherwise you have $Out to be the CSV string you need.    
file_put_contents($OutFileName, $Out);
</code></pre>

<p>Alternatively, if you want everything in a big array</p>

<pre><code>$file = fopen($datafile, 'r'); 

$aT = array();
$LastStore = '';
while (($result = fgetcsv($file)) !== false) 
{ 
    if (preg_match('/\d{10}$/', $result[0],$store)) { 
        $LastStore = $store;
    } elseif (preg_match('/^\d{7}/', $result[0],$transaction)) { {
        $aT[] = array("Store"=&gt;$LastStore, "Item"=&gt;$transaction[0],"Desc"=&gt;$transaction[1],"Qty"=&gt;$transaction[2],"Price"=&gt;$transaction[3])
    }
} 
fclose($file); 
</code></pre>

<p>Replace</p>

<pre><code>  request.env['devise.mapping'] = Devise.mappings[:user]
</code></pre>

<p>With</p>

<pre><code>  @request.env['devise.mapping'] = Devise.mappings[:user]
</code></pre>

<p>Notice the error message specifically suggests to use:</p>

<pre><code> 2) You are testing a Devise controller bypassing the router.
      If so, you can explicitly tell Devise which mapping to use:

      @request.env["devise.mapping"] = Devise.mappings[:user]
</code></pre>

<p>htmlentities replaces <code>&lt;</code> and <code>&gt;</code> with <code>&amp;lt;</code> and <code>&amp;gt;</code>, so you need to search for the replacements in your regexp.</p>

<pre><code>$output = preg_replace( 
  array( '#\s*&amp;lt;[\/\s]*(br|hr|/p|/div)[\/\s]*&amp;gt;\s*#iu', '#\s+#' ), 
  ' ', 
  $output );
echo $output;
</code></pre>

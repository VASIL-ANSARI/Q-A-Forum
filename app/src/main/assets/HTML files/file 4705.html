<p>To work this one out you need to work from the inside out. Figure out what the inner most query returns, then match that result against the where clause, continue until you reach the top.</p>

<pre><code>select item_id 
from `sales_flat_quote_item` 
where quote_id = 12670
</code></pre>

<p>This gives you a list of item_id's where the quote_id is 12670.</p>

<pre><code>select item_id 
from `sales_flat_quote_item_option`
where item_id in (Previous Result Set)   
and code = 'is_gift'
</code></pre>

<p>This gives you a list of item_id's where the item_id is contained in the previous list AND the code column = 'is_gift'</p>

<pre><code>select sum(qty) as 'total' 
from `sales_flat_quote_item`     
where item_id not in (Previous Result Set) 
and quote_id = 12670 and parent_item_id is null  
</code></pre>

<p>This returns the sum total of the qty field and names it 'total' where the item_id is not in the previous result set AND has a quote_id of 12670 and does not have a parent_item_id.</p>

<p>That should be enough for you to re-craft your query, but if your still having trouble post me a comment and I'll see if I can rewrite it given the above information (sans table designs).</p>

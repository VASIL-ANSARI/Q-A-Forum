<p>You can do it in many ways:</p>

<ul>
<li>Launch an <a href="http://www.w3schools.com/jsref/event_onbeforeunload.asp" rel="nofollow">AJAX call on <code>onbeforeunload</code> javascript event</a>. Prompting for a confirmation "Windows is closing, are you sure? YES/NO" should give you enough time to set the flag in the db, just be sure that if the user clicks "NO" you should unset your flag</li>
<li>Check session time... Add a var in your <code>PHP_SESSION</code> that is updated at every user event. If it becomes older than a preset threshold (i.e. 5 minutes), you can safely assume the user is gone</li>
</ul>

<p>Example for <code>onbeforeunload</code></p>

<pre><code>function myConfirmation() {
    return 'Are you sure you want to quit?';
}

window.onbeforeunload = myConfirmation;
</code></pre>

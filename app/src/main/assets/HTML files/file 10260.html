<p>From the <a href="http://prawn.majesticseacreature.com/docs/0.11.1/Prawn/Document.html#method-c-generate" rel="nofollow">fine manual</a>:</p>

<blockquote>
  <p>When using the implicit block form, Prawn will evaluate the block within an instance of <code>Prawn::Document</code>, simplifying your syntax. However, please note that you will not be able to reference variables from the enclosing scope within this block.</p>

<pre><code>Prawn::Document.generate "example.pdf" do
    # ...
</code></pre>
  
  <p>If you need to access your local and instance variables, use the explicit block form shown below. In this case, Prawn yields an instance of <code>PDF::Document</code> and the block is an ordinary closure:</p>

<pre><code>Prawn::Document.generate "example.pdf" do |pdf|
    #...
</code></pre>
</blockquote>

<p>Your block in <code>to_pdf</code> is being evaluated in the content of a <code>Prawn::Document</code> instance, not within the context of your object and that means that there is no <code>@data</code> instance variable so <code>@data</code> is created with a value of <code>nil</code> when you try to access it. You probably want to use a block with a single argument:</p>

<pre><code>Document.generate("#{@filename}.pdf") do |pdf|
  # do things to 'pdf' in here
</code></pre>

<p>Here</p>

<pre><code>allow(game).to receive(:shape).and_return(:rock)
</code></pre>

<p>and there </p>

<pre><code>allow(game).to receive(:player_shape).and_return(:paper)
</code></pre>

<p>You're stubbing methods <code>Game#shape</code> and <code>Game#player_shape</code> for <code>game</code> object.
But you're using <code>@shape == @player_shape</code> as condition in <code>if</code> statement.</p>

<p>Ruby treats undefined instance variables (those which starts from <code>@</code>) as <code>nil</code> by default.</p>

<pre><code>â irb
irb(main):001:0&gt; @shape
=&gt; nil
</code></pre>

<p>Thus <code>@shape == @player_shape</code> is the same as <code>nil == nil</code> in your case. Which is actually a <code>true</code>. What's why program flow reach <code>@result = :draw</code> line.</p>

<p>To make it work you need to define <code>shape</code> and <code>player_shape</code> methods by using <a href="http://ruby-doc.org/core-2.2.1/Module.html#method-i-attr_reader" rel="nofollow">attr_reader</a>, for example, and use them instead of instance variables.</p>

<p><strong>upd</strong></p>

<p>Now replace <code>@shape</code> with <code>shape</code> and <code>@player_shape</code> with <code>player_shape</code> in your code. Be sure you initialise values for them. </p>

<p>Take a look at <a href="https://rubymonk.com/learning/books/4-ruby-primer-ascent/chapters/45-more-classes/lessons/110-instance-variables" rel="nofollow">that Ruby Monk tutorial</a> (or any other articles) about instance vairables to understand how they work</p>

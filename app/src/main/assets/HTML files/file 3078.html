<p>Your structure doesn't actually contain an array, it contains a pointer.  If you really want variable-length structures, you'll need to keep a size field in there so that you know how big it is.  The <a href="http://c-faq.com/struct/structhack.html" rel="nofollow">C FAQ</a> has an example of exactly what it looks you're trying to do.  In your case it might look something like this:</p>

<pre><code>typedef struct {
    int ref; 
    double ary[1];
} refAry;

#define SIZE_OF_REFARY (sizeof(refAry) - sizeof(double))
</code></pre>

<p>To allocate:</p>

<pre><code>size_t alloc_size = SIZE_OF_REFARY + 10*sizeof(double);
refAry *a = malloc(alloc_size);
a-&gt;ref = 10;
</code></pre>

<p>To write:</p>

<pre><code>fwrite(a, SIZEP_OF-REFARY + a-&gt;ref * sizeof(double), 1, file);
</code></pre>

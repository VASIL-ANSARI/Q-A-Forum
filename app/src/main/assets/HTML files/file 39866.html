<p>Most likely your problem is here:</p>

<pre><code>struct ip *ip_hdr = (struct ip*) data + sizeof(struct ether_header);
struct tcphdr *tcp_hdr = (struct tcphdr*) data + sizeof(struct ether_header) + size_ip;
</code></pre>

<p>Doing <code>(struct ip*) data + sizeof(struct ether_header)</code> first casts data to <code>struct ip *</code>, then  adds <code>sizeof(struct ether_header)</code> to it, which we know from pointer arithmetics will not do what you expect it to do.</p>

<p>If the problem is still unclear, here's a simple program that should point you in the right direction:</p>

<pre><code>#include &lt;stdio.h&gt;

struct foo {
    int a, b;
};

int
main(int argc, char **argv)
{
    char *x = NULL;

    printf("%p\n", x);
    printf("%p\n", (struct foo *)x + 4);
    printf("%p\n", (struct foo *)(x + 4));

    return 0;
}
</code></pre>

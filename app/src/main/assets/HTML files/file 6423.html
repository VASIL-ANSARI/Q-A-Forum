<p>The W3C Geolocation API is <em>asynchronous</em>; the success callback function you have (which sets the variable <code>latlng</code>) won't be called immediately -- the browser requires some time to actually do the geolocating; in fact, if the user takes some time to read the privacy prompt and decide whether or not to give permission, this process could take many seconds. In the meantime though, your map is loaded immediately.</p>

<p>You're probably finding that it works with an alert after it because the alert gives the browser some time to finish the geolocation process and call the callback before getting to the code that loads the map. (Just waiting a second or two isn't a good solution though: some users and browsers will take much longer than that before revealing location.)</p>

<p>To fix: call the function that creates the map (you'll want to encapsulate practically everything after the geolocation call) and call it both in the success callback for <code>getCurrentPosition</code> and in the geoip else branch. That way you'll only try to load the map after you're guaranteed that the <code>latlng</code> variable has been appropriately filled.</p>

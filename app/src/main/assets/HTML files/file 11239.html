<p>I see two problems:</p>

<pre><code>CGContextDrawImage(ctx, CGRectMake(0, 0, maskWidth, maskHeight), image);
</code></pre>

<p>doesn't extract the alpha, it just alpha-composites the image onto a black background.
If the image is black with transparency then an all-black image would be the expected output.</p>

<p>and:</p>

<pre><code>CGImageRef mask = CGImageMaskCreate(maskWidth, maskHeight, 8, 8, bytesPerRow,
                                    dataProvider, NULL, FALSE);
</code></pre>

<p>You're treating this mask you create like a real image. If you replace this line with</p>

<pre><code>CGImageRef mask = CGImageCreate(maskWidth, maskHeight, 8, 8, bytesPerRow, colorSpace, 0,
                                dataProvider, NULL, FALSE, kCGRenderingIntentDefault);
</code></pre>

<p>Then you will get a greyscale version of your image (see problem 1)</p>

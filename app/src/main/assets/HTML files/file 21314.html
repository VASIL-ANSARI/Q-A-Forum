<p>This expression:</p>

<pre><code>CASE    
 WHEN m.uid_recipient &lt;&gt; 292 THEN @user_id := m.uid_recipient
 WHEN m.uid_sender &lt;&gt; 292 THEN @user_id := m.uid_sender
END 
</code></pre>

<p>is, I believe, assiging values to the @user_id variable.  There is no rule on when this is evaluated relative to other expressions in the query.  I would make an educated guess that expressions in the <code>SELECT</code> clause are always evaluated after joins and group bys.  In that case, the value used in the <code>from</code> clause is always the initial value.</p>

<p>I think you should just move it to the <code>from</code> clause:</p>

<pre><code>FROM messages m join
     signup s
     ON s.uid = (CASE WHEN m.uid_recipient &lt;&gt; 292 THEN m.uid_recipient
                      WHEN m.uid_sender &lt;&gt; 292 THEN  m.uid_sender
                 END)
</code></pre>

<p>There are probably other ways to express this, but this is a start.</p>

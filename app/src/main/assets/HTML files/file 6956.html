<p>Here is how I would do this:</p>

<h2>Format the data pulled from the database into a basic id-indexed array and a foreign-key-indexed array</h2>

<ul>
<li><p>Pull all messages from the database that are NOT replies, order by date.</p></li>
<li><p>Index the resulting array by message id.</p></li>
<li><p>Pull all messages from the database that are replies, order by date.</p></li>
<li><p>Loop over the replies, putting them into a new, multidimentional array, grouped by reply_id.</p></li>
</ul>

<h2>Formatting of output</h2>

<p>Foreach loop over non-reply messages:</p>

<ul>
<li><p>Display each message.</p></li>
<li><p>Pull the id of each message and check whether it is a key in the replies array.</p></li>
<li><p>If it is present in the replies array...</p>

<ul>
<li>Foreach loop to display each reply message that is present.</li>
</ul></li>
</ul>

<p>End of message foreach loop.</p>

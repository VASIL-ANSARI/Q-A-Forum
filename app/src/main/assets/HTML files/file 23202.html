<p><strong>You are executing the query twice</strong>: first, in <code>mysql_query($query) or die(mysql_error());</code> and second, in <code>if(mysql_query($query))</code>. So the second time the query executes the record is already there and thus the insertion fails.</p>

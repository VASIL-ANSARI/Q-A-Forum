<p>When the Enumerator in the <code>file</code> variable reaches then end, the <code>next</code> method will raise a <code>StopIteration</code> exception, but you are not rescuing it so that is likely the issue here.</p>

<p>You probably want to wrap it in a begin-rescue block, e.g.:</p>

<pre><code>Net::HTTP::Server.run(:port =&gt; 2000) do |request, stream|
  begin
    body = file.next
  rescue StopIteration
    body = []
  end

  [200, headers, body]
end
</code></pre>

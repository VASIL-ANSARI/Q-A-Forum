<p>Try this approach:</p>

<pre><code>while(true) {
    $key =  mt_rand(100000, 999999);
    $sql= "SELECT * FROM sharing_keys
           WHERE unique_key LIKE $key";
    $result = $con-&gt;query($sql);
    if ($result-&gt;num_rows &gt; 0){
        $add = "INSERT INTO sharing_keys (unique_key)
        VALUES ($key)";
        if ($con-&gt;query($add) === TRUE) {
            echo $key;
        } else {
            echo "Error: " . $add . "&lt;br&gt;" . $con-&gt;error;
        }
        break;
    }else {
        //sleep for 2 seconds
        sleep(2);
    } 
}
</code></pre>

<p>I don't think it is a good idea to refresh in the middle of a request.</p>

<p>This logic will attempt to find the key and exit once found. if not it will sleep for 2 seconds then retry until found.</p>

<hr>

<p>If your only goal was to select a row randomly, then you should do it in the query because only God knows how long it will take. here is an example in mysql server :</p>

<pre><code>SELECT * FROM sharing_keys
ORDER BY RAND()
LIMIT 1
</code></pre>

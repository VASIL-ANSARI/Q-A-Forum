<p>You need to <code>compact()</code> the buffer after calling <code>decode()</code> (or <code>get()</code>, or <code>write()</code>, anything that takes data out of the buffer).</p>

<p>Youu shouldn't allocate a new buffer every time around that <code>while</code> loop, and you should break out of it if <code>read()</code> returned -1. I don't actually see a need for the <code>while</code> loop at all.</p>

<p>This is probably not the entire answer, but your use of <code>malloc_size</code> seems like a huge red flag to me.  This seems a non-portable extension, not governed by anything like ANSI, ISO or POSIX, and I have some doubts on how it might behave if passed a buffer that didn't come from <code>malloc</code>.  It seems like a sketchy thing to rely on.  (I would say if it's come to calling <code>malloc_size</code> you're already doing something wrong as a C coder, since C is all about knowing how big your buffers are upfront and not relying on non-portable libc functions to do your buffer-size-tracking work for you.)</p>

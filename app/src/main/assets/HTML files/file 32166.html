<p>Your problem is that the database API is asynchronous, so you will execute your ajax call while the database transaction has not yet finished.</p>

<p>One way to solve it, is to put the ajax call in the callback of the query function.</p>

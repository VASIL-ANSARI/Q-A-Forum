<p>I can't answer for sure... but the code smell for me is the "before(:each)" defined inside the helper. why don't you try:</p>

<pre><code>#support/controller_macros.rb
module ControllerMacros    
  def login_user
    @request.env["devise.mapping"] = Devise.mappings[:user]
    @user = Factory.create(:user)
    sign_in @user
  end
end
</code></pre>

<p>and</p>

<pre><code>#requests/some_spec.rb
require 'spec_helper'
describe "GET /guides/edit" do
  before(:each) do
    login_user     
  end
end
</code></pre>

<p>and if that fails - maybe it just can't find @request - in which case, pass it as a variable to login_user</p>

<p>Edit:</p>

<p>Looks like you might need to include the devise test helpers.
The <a href="https://github.com/plataformatec/devise" rel="nofollow">rdoc</a> says you should have this file:</p>

<pre><code># spec/support/devise.rb
RSpec.configure do |config|
  config.include Devise::TestHelpers, :type =&gt; :controller
end
</code></pre>

<p>Not sure if that differs from how you've already got it in spec_helper.rb
... looks pretty similar to me.</p>

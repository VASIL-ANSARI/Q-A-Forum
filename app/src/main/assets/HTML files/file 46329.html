<p>Statement <code>cin &gt;&gt; buf</code> does <strong>not</strong> fill the whole <code>buf</code> with data. It reads only next "set" of non-whitespace characters.
Change <code>cin &gt;&gt; buf</code> to <code>read(0, buf, sizeof(buf)) &gt; 0</code></p>

<p>If you insist on using C++ streams, change beginning of your loop to:</p>

<pre><code>while (!cin.eof()) {
    cin.read(buf, sizeof(buf));
    [...]
</code></pre>

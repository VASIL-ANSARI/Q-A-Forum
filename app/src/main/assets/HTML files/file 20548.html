<p>So here are some obvious, though not necessarily easy to hear, suggestions for cleaning up your coding approach to make your life easier, and potentially make your questions more answerable in the future:</p>

<h2>Separate the php and js cleanly</h2>

<p>Separate the php and javascript as much as possible.  If you must pass data from js to php, I suggest a much more disciplined approach that pre-initializes all php variables and then uses them in the javascript later:</p>

<pre><code>var counter = &lt;? js_escape($count-1); ?&gt;;
var fromPHP=&lt;? js_escape($s_to_json); ?&gt;; // Null if not available
var jsVarFromPhp = &lt;?php escape($necessary_var);?&gt;;
var anotherVariable = &lt;?php escape($another_var);?&gt;;
var materialArray = &lt;? echo json_encode($material_array);?&gt;;

// then the js actually does stuff with javascript variables, ideally wrapped within a function, no php in the logic of your javascript.
</code></pre>

<h2>Isolate the javascript behavior</h2>

<p>When you're dealing with a complex combination of languages like this, often it's good to isolate the php behavior from the javascript behavior.  <a href="http://jsfiddle.net" rel="nofollow">http://jsfiddle.net</a> is great for this, take the js behavior that you intend, and the html that you expect, and put it into a test case.  You'll have to turn your php variables into their values, but it will simplify the test case, so that's recommended to debug even for yourself.</p>

<h2>Get out of the habit of using echo directly in your html</h2>

<p>You are echoing stuff directly in your html.  That will lead to XSS eventually.  Save yourself the trouble and work with a templating engine (a tiny one if it's only a tiny project).  Smarty is popular, and works.  If you feel you -must- work in native php for some reason, try to avoid php logic in your html and give yourself a wrapper function to make the php as clean as possible, like:</p>

<pre><code>function h($dirty){
    echo htmlentities($dirty, ENT_QUOTES | ENT_IGNORE, 'UTF-8');
}
</code></pre>

<p>Used like so:</p>

<pre><code>&lt;input value='&lt;?php h($input_value);?&gt;'&gt;
</code></pre>

<p>I still recommend the template engine approach, though.</p>

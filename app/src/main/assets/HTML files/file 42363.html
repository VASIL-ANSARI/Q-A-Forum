<p>I'll tell you <em>one</em> thing wrong with your code, this line:</p>

<pre><code>(unsigned char)addr&gt;&gt;8
</code></pre>

<p>doesn't do what you seem to need.</p>

<p>It converts the value in <code>addr</code> into an <code>unsigned char</code> which (assuming 8-bit <code>char</code> and either 16-bit <code>int</code> or only using the lower 16 bits of a wider <code>int</code>), will will always give you the lower eight bits.</p>

<p>If you then right shift that by eight bits, you'll always end up with zero.</p>

<p>If your intent is to get the upper eight bits of the address, you need to use:</p>

<pre><code>(unsigned char)(addr&gt;&gt;8)
</code></pre>

<p>so that the shift is done <em>first.</em></p>

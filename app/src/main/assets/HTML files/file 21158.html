<p>I'm doubtful about the whole solution but if you want to force a download, that is avoid the cache, you may replace</p>

<pre><code>imgTmp.src = 'test.png';
</code></pre>

<p>with</p>

<pre><code>imgTmp.src = 'test.png?t='+(new Date().getTime());
</code></pre>

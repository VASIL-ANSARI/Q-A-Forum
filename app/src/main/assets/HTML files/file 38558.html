<p><a href="http://tcpreplay.synfin.net/" rel="nofollow">tcpreplay</a> is a set of tools that does what you're asking. It's open source so you could look at how it works, and you may even find you can use it without needing to roll your own or modify it.</p>

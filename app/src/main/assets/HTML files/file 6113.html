<p>The best way of improving performance would be to ditch the UDF entirely. </p>

<p>One immediate thing that occurs to me is that </p>

<pre><code>LTRIM(RTRIM(Code)) = @Code
</code></pre>

<p>is not sargable so each call (i.e. <strong>every row</strong> returned in your outer query) could lead to up to 4 table scans.</p>

<p>If you replace the logic in the UDF with a CASE expression inline in the query you may well get a <a href="http://blogs.msdn.com/b/craigfr/archive/2006/08/23/715306.aspx">much superior execution plan</a>. Even if you can not make the predicate sargable at least it will allow the optimiser to explore different join strategies such as hash join rather than forcing repeated scans of the same tables.</p>

<p>First good thing is to move that code from view or controller to model and wrap it in scope. Moreover, scopes can be chained.</p>

<pre><code>class Server &lt; ActiveRecord::Base
  scope :averaged, -&gt; { where(SQL CODE HERE) }
  scope :expensive, -&gt; { where('price &gt; ?', price) }
  scope :latest, -&gt; { where('created_at &gt; ?', Date.today - 3.days.ago) }
  scope :active, -&gt; { where(active: true) }
end
</code></pre>

<p>Only then you can pass and chain it in controller:</p>

<pre><code>@servers = Server.latest.averaged
</code></pre>

<p>So, simply try to brake your SQL on several parts, move these parts to model and wrap them with scopes.
You can find a lot of useful examples of query methods without pure SQL here:
<a href="http://guides.rubyonrails.org/active_record_querying.html" rel="nofollow">http://guides.rubyonrails.org/active_record_querying.html</a></p>

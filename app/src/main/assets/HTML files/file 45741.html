<p><strong>Create a OmniauthCallbacksController and Add the following code</strong></p>

<pre><code>class OmniauthCallbacksController &lt; ApplicationController
  skip_before_filter :authenticate_user!
  def all
    p env["omniauth.auth"]
    user = User.from_omniauth(env["omniauth.auth"])
    if user.persisted?
      # flash[:alert] = "You have to confirm your account before continuing."
      sign_in_and_redirect(user)
    else
      session["devise.user_attributes"] = user.attributes
      redirect_to new_user_registration_url
    end
  end

    def failure
      #handle you logic here..
      #and delegate to super.
      redirect_to new_user_registration_url
    end


  alias_method :facebook, :all
end
</code></pre>

<p>In your config/routes.rb</p>

<pre><code>devise_for :users, controllers: { omniauth_callbacks: "omniauth_callbacks" }
</code></pre>

<p><strong>Create a Authorization model</strong></p>

<pre><code>rails g model Authorization
</code></pre>

<p><strong>In migration add following code</strong></p>

<pre><code>class CreateAuthorizations &lt; ActiveRecord::Migration
  def change
    create_table :authorizations do |t|
      t.string :provider
      t.string :uid
      t.integer :user_id
      t.string :token
      t.string :secret
      t.timestamps
    end
  end
end
</code></pre>

<p><strong>then</strong></p>

<pre><code>rake db:migrate
</code></pre>

<p><strong>In your models/authorization.rb</strong></p>

<pre><code>belongs_to :user
</code></pre>

<p><strong>In your models/user.rb</strong></p>

<pre><code>has_many :authorizations

def self.from_omniauth(auth)
  authorization = Authorization.where(:provider =&gt; auth.provider, :uid =&gt; auth.uid.to_s).first_or_initialize
  authorization.token = auth.credentials.token
  if authorization.user.blank?
    user = User.where('email = ?', auth["info"]["email"]).first
    if user.blank?
     user = User.new
     user.password = Devise.friendly_token[0,10]
     user.email = auth.info.email
     user.save
    end
   authorization.user_id = user.id       
  end
  authorization.save
  authorization.user
end
</code></pre>

<p>Hope this will help you.</p>

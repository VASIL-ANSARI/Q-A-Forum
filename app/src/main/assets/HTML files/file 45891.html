<p>You're flushing the <code>MemoryStream</code>, but not the <code>StreamWriter</code>. It's possible that that's buffering.</p>

<p>Call <code>sb.Flush()</code> instead of <code>stream.Flush()</code>. (Flushing a <code>MemoryStream</code> doesn't do anything anyway.)</p>

<p>Also note that you can use <code>MemoryStream.CopyTo</code> without rewinding, instead of <code>Stream.WriteTo</code>.</p>

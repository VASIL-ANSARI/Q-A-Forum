<p>simple create User define function and use in select query</p>

<pre><code>  alter function UDF_GetPercentage(@UserId int)
returns decimal(18,10)
as begin 

declare @Percentage decimal(18,10)
SELECT @Percentage = cast(
(SELECT count(*) FROM 
(SELECT user_id FROM tbl_GroupUser WHERE group_id in 
(SELECT group_id FROM (SELECT t1.group_id, count(distinct t1.user_id) as numberOfUsers 
FROM tbl_GroupUser as t1 JOIN tbl_GroupUser as t2 ON t1.group_id = t2.group_id group by
t1.group_id) y 
WHERE y.numberOfUsers = 2)
)
as x

WHERE x.user_id in (@UserId)
) as decimal)
* 100 
/
(SELECT count(*) FROM tbl_GroupUser WHERE user_id in (@UserId ))

return @Percentage

end
</code></pre>

<p>and use in select query like this</p>

<pre><code>SELECT   user_id, dbo.UDF_GetPercentage(user_id) as p_Grp2
FROM     tbl_GroupUser
group by user_id
</code></pre>

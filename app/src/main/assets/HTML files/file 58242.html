<p>Your function appears to be retrieving the query AFTER attempting to write to the file.</p>

<p>As it looks like you are planning to retrieve the data, write it to a file, and then return the data for further use in your application, I would suggest something like below.</p>

<pre><code>function getPostsToMove($baseurl){  
    $baseurl = $baseurl.'/%/%/%.%';
    $myfile = fopen("/websites/site.dev/wp-content/uploads/newfile.txt", "w") or die("Unable to open file!");

    // Query the data and assign the variable before writing
    global $wpdb;
    $results = $wpdb-&gt;get_results("SELECT * FROM $wpdb-&gt;posts WHERE `guid` not like '$baseurl' and `post_type` = 'attachment' ORDER BY post_date DESC LIMIT 1000");

    // json_encode() to turn the retrieved array into a JSON string for writing to text file
    $output = json_encode($results);

    // write the file
    fwrite($myfile, $output);
    fclose($myfile);

    // return the result (array) for further use in application
    return $results
}
</code></pre>

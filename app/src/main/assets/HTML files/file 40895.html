<p>Apart from the work-around provided if we want 100% code coverage while in test we can try the below.</p>

<p>Do not close the stream if it is StringIO</p>

<pre><code>@tmp_file.close unless @tmp_file.is_a?(StringIO)
</code></pre>

<p>so we dont need to open it while in test.</p>

<pre><code>    def add_row_to_file(row)
      @tmp_file = File.open(@tmp_file, 'a+') unless @tmp_file.is_a?(StringIO)
      @tmp_file.print(row.to_json + "\n")
    end
</code></pre>

<p>In this way we can achieve the Tempfile testing without actually creating Files while in test environment and having 100% code coverage while in test.</p>

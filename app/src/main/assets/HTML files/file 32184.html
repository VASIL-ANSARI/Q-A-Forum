<pre><code>SELECT name, metric_1, metric_2
FROM customer AS c
LEFT JOIN (SELECT customer_id, COUNT(*) AS metric_1
           FROM metric1 AS m
           INNER JOIN metric1_lineitem AS l ON m.id = l.metric1_id
           GROUP BY customer_id) m1
ON m1.customer_id = c.customer_id
LEFT JOIN (SELECT customer_id, COUNT(*) AS metric_2
           FROM metric2 AS m
           INNER JOIN metric2_lineitem AS l ON m.id = l.metric2_id
           GROUP BY customer_id) m1
ON m2.customer_id = c.customer_id
ORDER BY metric_1 DESC
LIMIT 5
</code></pre>

<p>You should also avoid using <code>COUNT(columnname)</code> when you can use <code>COUNT(*)</code> instead. The former has to test every value to see if it's null.</p>

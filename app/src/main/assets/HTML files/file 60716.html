<p>This should provide some insight.</p>

<pre><code>#include &lt;iostream&gt;
#include &lt;string&gt;

template&lt;class Func&gt;
void reverse_iterate_messages(std::string const&amp; buffer, Func&amp;&amp; f)
{
    auto current = buffer.size();

    while (current)
    {
        auto pos = buffer.rfind("%(", current - 1);
        auto end_name = buffer.find(")%", pos + 2);
        if (end_name &lt; current)
        {
            auto name = buffer.substr(pos + 2, end_name - pos - 2);
            auto message = buffer.substr(end_name + 2, current - end_name - 2);
            f(name, message);
            current = pos;
        }
        else {
            break;   // incorrectly formatted string
        }
    }

}

void show(std::string const&amp; name, std::string message)
{
    if (name == "Jane")
    {
        for (std::size_t pos = 0 ; pos &lt; message.size() ; )
        {
            auto i = message.find("$^", pos);
            if (i == std::string::npos)
                break;
            message.replace(i, 2, "\n");
            pos = i + 1;
        }
        std::cout &lt;&lt; message;
    }
}

int main()
{
    auto test_string = "%(Jane)%Hey$^How are you?$^%(Jane)%How was your summer?$^";
    reverse_iterate_messages(test_string, show);

}
</code></pre>

<p>expected output:</p>

<pre><code>How was your summer?
Hey
How are you?
</code></pre>

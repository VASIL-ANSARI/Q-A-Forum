<p>The csv export code is very compact, especially this line:</p>

<pre><code>csv &lt;&lt; ccts.attributes.values_at(*mycolumns)
</code></pre>

<p>That makes it difficult to think about how to change it.</p>

<p>First think how you would export your value if it was a single column. It may look something like:</p>

<pre><code>if column_name == :name
  lookup_fruit_name(ccts.name)
else
  ccts[column_name]
end
</code></pre>

<p>Now you need all the values of a <code>ccts</code> inside an array, so it can be sent to csv:</p>

<pre><code>values = mycolums.map do |column_name|
  if column_name == :name
    lookup_fruit_name(ccts.name)
  else
    ccts[column_name]
  end
end
csv &lt;&lt; values
</code></pre>

<p>Then just place this inside the inner loop of your original export method.</p>

<p>If you think more functional, you just write an instance method that gets your value and does a conversion depending on the column:</p>

<pre><code>def csv_value_for(column_name)
  if column_name == :name
    lookup_fruit_name( self.name )
  else
    self[column_name]
  end
end
</code></pre>

<p>Then you can use it like this:</p>

<pre><code>csv &lt;&lt; mycolumns.map{|col| ccts.csv_value_for(col) }
</code></pre>
